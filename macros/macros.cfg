# macros
[gcode_macro _olli_globals]
variable_print_min: (0,0)
variable_print_max: (310,310)
variable_filament_load_length: 10
variable_filament_load_speed: 5
variable_purge_margin: 0
variable_purge_length: 10
variable_purge_speed: 20
variable_move_speed: 40
gcode:

[gcode_macro START_PRINT]
gcode:
    {% set olli = printer["gcode_macro _olli_globals"] %}
    {% set BED_TEMP = params.BED_TEMP|default(50)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set MOVE_SPEED = params.MOVE_SPEED|default(olli.move_speed)|float %}
    #reset
    G90 ; use absolute coordinates
    M82 ; extruder absolute mode
    G92 E0 ; reset extruder
    SET_GCODE_OFFSET Z=0.0
    BED_MESH_CLEAR

    #inital heatup without wait
    M104 S100 ; nozzle no ooze temperature
    M140 S{BED_TEMP}
    #conditional homing
    _CG28
    G1 X{olli.print_min[0]} Y{olli.print_min[1]} F{MOVE_SPEED * 60}
    M190 S{BED_TEMP}
    BED_MESH_CALIBRATE
    M104 S{EXTRUDER_TEMP} ; set final nozzle temp
    G1 X{olli.print_min[0]} Y{olli.print_min[1]} F{MOVE_SPEED * 60} ; move to ooze position
    M109 S{EXTRUDER_TEMP} ; wait for nozzle temp to stabilize
    # purge line etc.
    DRAW_PURGE_LINE PRINT_MIN=125,125 PRINT_MAX=185,185 WIDTH=0.5 HEIGHT=0.2 LENGTH=10
    G1 Z25
    #end code
    M140 S0 ; turn off heatbed
    M104 S0 ; turn off temperature
    M107 ; turn off fan

[gcode_macro set_draw_params]
description: Sets the default parameters used by DRAW_LINE_TO.
  Usage: SET_DRAW_PARAMS [HEIGHT=<mm>] [WIDTH=<mm>] [FEEDRATE=<mm/m>]
variable_height: 0.2
variable_width: 0.0 # Set to nozzle_diameter at startup
variable_feedrate: 1200
gcode:
  {% set dparams = printer["gcode_macro set_draw_params"] %}
  {% for k in params %}
    {% set kl = k|lower %}
    {% if kl in dparams %}
      {% if dparams[kl] is float %}
        {% set v = params[k]|float %}
      {% elif dparams[kl] is integer %}
        {% set v = params[k]|int %}
      {% endif %}
      SET_GCODE_VARIABLE MACRO=set_draw_params VARIABLE={kl} VALUE="{v}"
    {% endif %}
  {% endfor %}

[gcode_macro draw_line_to]
description: Extrudes a line of filament at the specified height and width from
  the current coordinate to the supplied XY coordinate. (The height is used only
  to calculate the extrusion volume.)
  Usage: DRAW_LINE_TO [X=<pos>] [Y=<pos>] [HEIGHT=<mm>] [WIDTH=<mm>]
                      [FEEDRATE=<mm/m>]
gcode:
  {% set dparams = printer["gcode_macro set_draw_params"] %}
  {% set position = printer.gcode_move.gcode_position %}
  {% set X = params.X|default(position.x)|float %}
  {% set Y = params.Y|default(position.y)|float %}
  {% set HEIGHT = params.HEIGHT|default(dparams.height)|float %}
  {% set WIDTH = params.WIDTH|default(dparams.width)|float %}
  {% set FEEDRATE = params.FEEDRATE|default(dparams.feedrate)|int %}

  {% set distance = ((X - position.x) ** 2 + (Y - position.y) ** 2) ** 0.5 %}

  {% set filament_area = 3.14159 *
       (printer.configfile.settings[
          printer.toolhead.extruder].filament_diameter ** 2) / 4 %}
  {% set E = distance * ((WIDTH * HEIGHT) / filament_area) %}

  # Use the base state call here so offset adjustments get persisted.
  SAVE_GCODE_STATE NAME=drawline

  G90
  G92 E0.0
  G1 X{"%.3f" % X} Y{"%.3f" % Y} E{"%.5f" % E} F{FEEDRATE}
  RESTORE_GCODE_STATE NAME=drawline MOVE=0

[gcode_macro draw_purge_line]
description: Purges the specified length of filament as a line (or rows of
  lines) in front of the supplied print area. If no print area is specified the
  purge lines are drawn at the front edge of the maximum printable area. If no
  printable area is set it defaults to the XY axis limits.
  Usage: DRAW_PURGE_LINE [PRINT_MIN=<X,Y>] [PRINT_MAX=<X,Y>] [HEIGHT=<mm>]
                         [WIDTH=<mm>] [LENGTH=<mm>]
gcode:
  # TODO: Make this work for delta printers.
  {% set olli = printer["gcode_macro _olli_globals"] %}
  {% set origin = printer.gcode_move.homing_origin %}
  {% if "PRINT_MIN" in params %}
    {% set PRINT_MIN = (
        (params.PRINT_MIN.split(",")[0]|float, olli.print_min[0])|max,
        (params.PRINT_MIN.split(",")[1]|float, olli.print_min[1])|max
      ) %}
  {% else %}
    {% set PRINT_MIN = olli.print_min %}
  {% endif %}
  {% if "PRINT_MAX" in params %}
    {% set PRINT_MAX = (
        (params.PRINT_MAX.split(",")[0]|float, olli.print_max[0])|min,
        (params.PRINT_MAX.split(",")[1]|float, olli.print_max[1])|min
      ) %}
  {% else %}
    {% set PRINT_MAX = olli.print_max %}
  {% endif %}
  {% set extruder = printer.toolhead.extruder|string %}
  {% set HEIGHT = params.HEIGHT|default(0.4 * 0.625)|float %}
  {% set WIDTH = params.WIDTH|default(0.4 * 1.25)|float %}
  {% set LENGTH = params.LENGTH|default(olli.purge_length)|float %}

  {% set dparams = printer["gcode_macro set_draw_params"] %}
  {% set filament_area = 3.14159 *
       (printer.configfile.settings[extruder].filament_diameter ** 2) / 4 %}
  {% set purge_length = (LENGTH * filament_area) / (WIDTH * HEIGHT) %}
  {% set printable_length = PRINT_MAX[0] - PRINT_MIN[0] %}
  {% set purge_rows = (purge_length / printable_length)|round(0,'ceil')|int %}
  {% set printable_inset = (printable_length - purge_length / purge_rows) / 2 %}
  {% set PRINT_MIN = (PRINT_MIN[0] + printable_inset, PRINT_MIN[1]) %}
  {% set PRINT_MAX = (PRINT_MAX[0] - printable_inset, PRINT_MAX[1]) %}
  # This will purge into the print area when the bed is filled to the front.
  {% set y_start = (olli.print_min[1], PRINT_MIN[1] - olli.purge_margin-(purge_rows + 0.5) * WIDTH )|max %}
  G90
  # Jog to the front left corner to get strings out of the print area.
  G1 X{"%.3f" % (PRINT_MIN[0] - 30, olli.print_min[0])|max} Y{
    "%.3f" % (y_start - 10, olli.print_min[1])|max} F{olli.move_speed*60}
  # Move to the starting corner.
  G1 X{"%.3f" % (PRINT_MIN[0] - 2, olli.print_min[0])|max} Y{"%.3f" % y_start} Z{
    "%.4f" % HEIGHT} F{olli.move_speed*60}
  # Prime the extruder before beginning the purge lines.
  {% if olli.filament_load_length > 0 %}
    G92 E0.0
    G1 E{"%.3f" % olli.filament_load_length} F{olli.filament_load_speed*60}
  {% endif %}
  G92 E0.0
  # Purge.
  set_draw_params HEIGHT="{HEIGHT}" WIDTH="{WIDTH}" FEEDRATE="{olli.purge_speed*60}"
  G1 X{"%.3f" % PRINT_MIN[0]} F{olli.purge_speed*60}
  {% for n in range(purge_rows - 1) %}
    {% set x_pos = PRINT_MIN[0] if n % 2 else PRINT_MAX[0] %}
    DRAW_LINE_TO X="{x_pos}" Y="{WIDTH * n + y_start}"
    DRAW_LINE_TO X="{x_pos}" Y="{WIDTH * (n + 1) + y_start}"
  {% endfor %}
  {% set x_pos = PRINT_MAX[0] if purge_rows % 2 else PRINT_MIN[0] %}
  DRAW_LINE_TO X="{x_pos}" Y="{WIDTH * (purge_rows - 1) + y_start}"
  G92 E0.0